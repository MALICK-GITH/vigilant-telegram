<script>
(async function(){
  const box = document.getElementById("list");

  let res;
  try { res = await fetch("/data.json?ts=" + Date.now(), { cache: "no-store" }); }
  catch(e){ box.innerHTML = `<div class="card"><b>Erreur rÃ©seau :</b> impossible de charger data.json</div>`; return; }

  if(!res.ok){
    box.innerHTML = `<div class="card"><b>Erreur :</b> data.json introuvable (${res.status})</div>`;
    return;
  }

  const data = await res.json();
  const players = data.players || [];
  const matches = data.matches || [];

  if(players.length === 0){
    box.innerHTML = `<div class="card">Aucun joueur trouvÃ©.</div>`;
    return;
  }

  // âœ… Map: playerId -> derniÃ¨re preuve trouvÃ©e (dans un match terminÃ©)
  const lastProofByPlayer = {};
  matches
    .filter(m => m.status === "TERMINE" && m.proofUrl)
    .forEach(m => {
      // On attribue la mÃªme preuve aux 2 joueurs du match
      lastProofByPlayer[m.aId] = m.proofUrl;
      lastProofByPlayer[m.bId] = m.proofUrl;
    });

  function tagFor(status){
    if(status === "QUALIFIE") return `<span class="tag ok">ðŸŸ¢ QUALIFIÃ‰</span>`;
    if(status === "ELIMINE")  return `<span class="tag ko">ðŸ”´ Ã‰LIMINÃ‰</span>`;
    return `<span class="tag wait">ðŸŸ  EN ATTENTE</span>`;
  }

  box.innerHTML = "";

  players.forEach((p, idx) => {
    const proof = lastProofByPlayer[p.id];

    const proofMini = proof
      ? `
        <div style="margin-top:10px;">
          <div class="sub">ðŸ“¸ DerniÃ¨re preuve</div>
          <a href="${proof}" target="_blank" rel="noopener">
            <img
              src="${proof}"
              alt="Preuve du joueur"
              style="width:100%;max-width:420px;border-radius:14px;border:1px solid #1C2742;display:block;margin-top:6px;"
              loading="lazy"
            />
          </a>
        </div>
      `
      : `<div class="sub" style="margin-top:10px;">ðŸ“¸ Preuve : aucune</div>`;

    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="item">
        <div><b>${String(idx+1).padStart(2,"0")}.</b> ${p.name}</div>
        ${tagFor(p.status)}
      </div>
      ${proofMini}
    `;
    box.appendChild(div);
  });
})();
</script>