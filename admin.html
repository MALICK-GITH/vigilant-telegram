<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Äî LES √âLITES EFOOTPRO</title>
  <style>
    :root{
      --bg:#070A0F; --card:#0E1422; --txt:#EAF0FF; --muted:#A9B4D0; --line:#1C2742;
      --green:#25D366; --neon:#00E5FF; --amber:#FFB020; --red:#FF4D4D;
      --shadow: 0 12px 40px rgba(0,0,0,.45); --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(0,229,255,.10), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(37,211,102,.10), transparent 55%),
        radial-gradient(900px 500px at 50% 90%, rgba(255,176,32,.08), transparent 55%),
        var(--bg);
      color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      line-height:1.35; font-size:16px;
    }
    a{color:#CFE7FF;text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:980px;margin:0 auto;padding:22px}
    .card{
      margin-top:16px; border:1px solid var(--line); border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(14,20,34,.90), rgba(11,16,32,.90));
      box-shadow:var(--shadow); padding:18px;
    }
    h1,h2{margin:0 0 10px}
    h1{font-size:20px;letter-spacing:.5px}
    h2{font-size:16px;letter-spacing:.3px}
    .sub{color:var(--muted);font-size:13px}
    .kicker{color:var(--muted);font-size:11px;letter-spacing:.9px;text-transform:uppercase}
    .big{font-size:18px;font-weight:900}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .row2{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      padding:12px 14px;border-radius:16px;border:1px solid rgba(28,39,66,.9);
      background:rgba(255,255,255,.02); color:var(--txt); cursor:pointer; font-weight:800;
    }
    .btn:hover{border-color:rgba(0,229,255,.28);background:rgba(0,229,255,.06)}
    .btn.ghost{background:transparent}
    .btn.danger{border-color:rgba(255,77,77,.35);background:rgba(255,77,77,.10)}
    .btn.success{border-color:rgba(37,211,102,.35);background:rgba(37,211,102,.10)}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;font-size:12px;font-weight:800;
      border:1px solid rgba(28,39,66,.9);
    }
    .tag.q{border-color:rgba(37,211,102,.35);background:rgba(37,211,102,.10);color:#D8FFE8}
    .tag.e{border-color:rgba(255,77,77,.35);background:rgba(255,77,77,.10);color:#FFD6D6}
    .tag.a{border-color:rgba(255,176,32,.35);background:rgba(255,176,32,.10);color:#FFF0D0}
    .debug{
      padding:12px 14px;border-radius:14px;
      border:1px dashed rgba(0,229,255,.35);
      background:rgba(0,229,255,.06); color:#DDF9FF; font-size:12px;
      white-space:pre-wrap;
    }
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .tabbtn.active{border-color:rgba(37,211,102,.35);background:rgba(37,211,102,.10)}
    .hr{height:1px;background:rgba(28,39,66,.7);margin:14px 0}
    .list{display:grid;gap:12px}
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid rgba(28,39,66,.9); background:rgba(255,255,255,.02);
      color:var(--txt); outline:none;
    }
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(28,39,66,.9);background:rgba(255,255,255,.02);font-size:12px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
    .hide{display:none}
    .imgPrev img{width:100%;max-width:520px;border-radius:14px;border:1px solid var(--line);display:block}
    footer{margin:22px 0 8px;text-align:center;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üîê Admin ‚Äî LES √âLITES <span style="color:var(--green)">EFOOTPRO</span></h1>
      <div class="sub"><a href="/index.html">‚Üê Accueil</a> ¬∑ <a href="/candidats.html">Candidats</a> ¬∑ <a href="/matches.html">Matchs</a></div>
      <div id="debug" class="debug" style="display:none;margin-top:10px"></div>
    </div>

    <div id="loginCard" class="card">
      <h2>Connexion Admin</h2>
      <div class="sub">PIN par d√©faut : <b>****</b></div>
      <label>Entrer le PIN</label>
      <input id="pinInput" type="password" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <div class="row" style="margin-top:12px">
        <button id="btnLogin" class="btn">‚úÖ Se connecter</button>
        <button id="btnLogout" class="btn ghost hide">üö™ Se d√©connecter</button>
      </div>
      <div class="sub" style="margin-top:10px">
        ‚ö†Ô∏è Site statique : tout est enregistr√© sur <b>ton t√©l√©phone</b> (localStorage). Pour publier √† tous : <b>Export JSON</b> puis remplace <b>data.json</b> sur le d√©p√¥t.
      </div>
    </div>

    <div id="appCard" class="card hide">
      <h2>Console Admin</h2>

      <div class="tabs">
        <button class="btn tabbtn active" data-tab="dash">üìä Dashboard</button>
        <button class="btn tabbtn" data-tab="players">üë• Joueurs</button>
        <button class="btn tabbtn" data-tab="matches">‚öîÔ∏è Matchs</button>
        <button class="btn tabbtn" data-tab="io">üì§ Export / üì• Import</button>
        <button class="btn tabbtn" data-tab="settings">‚öôÔ∏è PIN</button>
      </div>

      <div class="hr"></div>

      <section id="tab-dash">
        <div id="dashSummary" class="sub">Chargement‚Ä¶</div>
      </section>

      <section id="tab-players" class="hide">
        <h2>Joueurs</h2>
        <div class="sub">Ne supprime jamais : change seulement le statut.</div>
        <label>Recherche</label>
        <input id="playerSearch" placeholder="Deku / +225 / 01..." />
        <div class="list" id="playersList" style="margin-top:12px"></div>
      </section>

      <section id="tab-matches" class="hide">
        <h2>Matchs</h2>
        <div class="sub">Valider = score + gagnant/perdant auto + preuve (URL .jpg/.png/.webp).</div>
        <div class="row2" style="margin-top:10px">
          <div style="min-width:220px;flex:1">
            <label>Round</label>
            <select id="roundFilter"></select>
          </div>
          <div style="min-width:220px;flex:1">
            <label>Nom Admin</label>
            <input id="adminName" placeholder="SOLITAIRE HACK üá®üáÆ" />
          </div>
        </div>
        
        <div class="card" style="margin-top:12px;">
          <h3>G√©n√©ration automatique des tours</h3>
          <div class="sub">G√©n√®re automatiquement le tour suivant quand tous les matchs du round actuel sont termin√©s</div>
          <div class="row" style="margin-top:10px;">
            <button id="btnGenerateNext" class="btn success">üîÑ G√©n√©rer le tour suivant</button>
            <div class="sub" id="generateStatus"></div>
          </div>
        </div>
        
        <div class="list" id="matchesList" style="margin-top:12px"></div>
      </section>

      <section id="tab-io" class="hide">
        <h2>Export / Import</h2>
        <div class="row2">
          <div class="card" style="flex:1">
            <h2>üì§ Export JSON</h2>
            <div class="sub">T√©l√©charge les donn√©es actuelles.</div>
            <div class="row" style="margin-top:10px">
              <button id="btnExport" class="btn">üì§ T√©l√©charger</button>
            </div>
          </div>
          <div class="card" style="flex:1">
            <h2>üì• Import JSON</h2>
            <div class="sub">Remplace localStorage par un fichier JSON.</div>
            <label>Fichier .json</label>
            <input id="importFile" type="file" accept="application/json" />
            <div class="row" style="margin-top:10px">
              <button id="btnImport" class="btn">üì• Importer</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>‚ôªÔ∏è Reset</h2>
          <div class="sub">Revenir √† data.json officiel (efface localStorage).</div>
          <div class="row" style="margin-top:10px">
            <button id="btnReset" class="btn danger">‚ôªÔ∏è R√©initialiser</button>
          </div>
        </div>
      </section>

      <section id="tab-settings" class="hide">
        <h2>Changer PIN</h2>
        <label>Nouveau PIN (4 √† 8 chiffres)</label>
        <input id="newPin" type="password" inputmode="numeric" placeholder="1234" />
        <div class="row" style="margin-top:12px">
          <button id="btnChangePin" class="btn">üîí Enregistrer</button>
        </div>
      </section>
    </div>

    <footer>Sign√© SOLITAIRE HACK üá®üáÆ</footer>
  </div>

  <script>
    const LS_KEY = "tournamentData";
    const PIN_KEY = "efootpro_admin_pin";
    const AUTH_KEY = "efootpro_admin_auth";

    const debugEl = document.getElementById("debug");
    const loginCard = document.getElementById("loginCard");
    const appCard = document.getElementById("appCard");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const pinInput = document.getElementById("pinInput");

    const tabBtns = [...document.querySelectorAll(".tabbtn")];
    const tabIds = ["dash","players","matches","io","settings"];

    const dashSummary = document.getElementById("dashSummary");
    const playerSearch = document.getElementById("playerSearch");
    const playersList = document.getElementById("playersList");

    const roundFilter = document.getElementById("roundFilter");
    const adminName = document.getElementById("adminName");
    const matchesList = document.getElementById("matchesList");

    const btnExport = document.getElementById("btnExport");
    const importFile = document.getElementById("importFile");
    const btnImport = document.getElementById("btnImport");
    const btnReset = document.getElementById("btnReset");

    const newPin = document.getElementById("newPin");
    const btnChangePin = document.getElementById("btnChangePin");
    const btnGenerateNext = document.getElementById("btnGenerateNext");
    const generateStatus = document.getElementById("generateStatus");

    let data = null;

    function debug(msg){
      debugEl.style.display = "block";
      debugEl.textContent = String(msg);
    }
    function clearDebug(){
      debugEl.style.display = "none";
      debugEl.textContent = "";
    }
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function getPin(){ 
      const stored = localStorage.getItem(PIN_KEY);
      if(stored) return stored;
      // PIN par d√©faut (un peu masqu√©)
      return String.fromCharCode(54,54,50,52); // "6624"
    }
    function setPin(p){ localStorage.setItem(PIN_KEY, p); }
    function isAuthed(){ return localStorage.getItem(AUTH_KEY)==="1"; }
    function setAuthed(v){ localStorage.setItem(AUTH_KEY, v?"1":"0"); }

    function normalizeData(d){
      if(!d.players) d.players = [];
      if(!d.matches) d.matches = [];
      if(!d.history) d.history = [];
      if(!d.config) d.config = { tournamentName:"LES √âLITES EFOOTPRO", mode:"√âlimination directe", rules:[] };
    }

    async function loadData(){
      const local = localStorage.getItem(LS_KEY);
      if(local){
        try{ const d = JSON.parse(local); normalizeData(d); return d; }
        catch(e){ localStorage.removeItem(LS_KEY); }
      }
      const res = await fetch("/data.json?ts="+Date.now(), {cache:"no-store"});
      if(!res.ok) throw new Error("data.json introuvable ("+res.status+")");
      const d = await res.json(); normalizeData(d); return d;
    }
    function saveData(d){
      normalizeData(d);
      localStorage.setItem(LS_KEY, JSON.stringify(d));
    }
    function resetData(){ localStorage.removeItem(LS_KEY); }

    function statusTag(status){
      if(status==="QUALIFIE") return `<span class="tag q">üü¢ QUALIFI√â</span>`;
      if(status==="ELIMINE") return `<span class="tag e">üî¥ √âLIMIN√â</span>`;
      return `<span class="tag a">üü† EN ATTENTE</span>`;
    }
    function getPlayerById(id){ return (data.players||[]).find(p=>p.id===id) || null; }

    function rounds(){
      const set = new Set((data.matches||[]).map(m=>m.round).filter(Boolean));
      const order = ["R32","R16","QF","SF","F"];
      const arr = [...set].sort((a,b)=>order.indexOf(a)-order.indexOf(b));
      return arr.length ? arr : ["R32"];
    }

    function countPlayers(){
      const ps = data.players||[];
      const q = ps.filter(p=>p.status==="QUALIFIE").length;
      const e = ps.filter(p=>p.status==="ELIMINE").length;
      const a = ps.filter(p=>p.status!=="QUALIFIE" && p.status!=="ELIMINE").length;
      return {q,e,a,total:ps.length};
    }
    function countMatches(){
      const ms = data.matches||[];
      const t = ms.filter(m=>m.status==="TERMINE").length;
      const aj = ms.filter(m=>m.status!=="TERMINE").length;
      return {t,aj,total:ms.length};
    }

    function showTab(name){
      tabIds.forEach(t=>{
        document.getElementById("tab-"+t).classList.toggle("hide", t!==name);
      });
      tabBtns.forEach(b=>b.classList.toggle("active", b.dataset.tab===name));
    }
    tabBtns.forEach(b=>b.addEventListener("click", ()=>showTab(b.dataset.tab)));

    function renderDashboard(){
      const pc = countPlayers();
      const mc = countMatches();
      dashSummary.innerHTML = `
        <div class="row2">
          <span class="pill">üë• Joueurs: <b>${pc.total}</b></span>
          <span class="pill">üü¢ Qualifi√©s: <b>${pc.q}</b></span>
          <span class="pill">üî¥ √âlimin√©s: <b>${pc.e}</b></span>
          <span class="pill">üü† En attente: <b>${pc.a}</b></span>
        </div>
        <div class="row2" style="margin-top:10px">
          <span class="pill">‚öîÔ∏è Matchs: <b>${mc.total}</b></span>
          <span class="pill">‚úÖ Termin√©s: <b>${mc.t}</b></span>
          <span class="pill">üïí √Ä jouer: <b>${mc.aj}</b></span>
        </div>
        <div class="sub" style="margin-top:10px">Test: ouvre <b>/data.json</b> pour v√©rifier la base.</div>
      `;
    }

    function renderPlayers(){
      const q = (playerSearch.value||"").toLowerCase().trim();
      const ps = (data.players||[]).map((p,idx)=>({p,idx})).filter(x=>{
        const n = x.p.name.toLowerCase();
        const num = String(x.idx+1).padStart(2,"0");
        return !q || n.includes(q) || num.includes(q);
      });

      playersList.innerHTML = "";
      ps.forEach(({p,idx})=>{
        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML = `
          <div class="row">
            <div>
              <div class="kicker">JOUEUR #${String(idx+1).padStart(2,"0")}</div>
              <div class="big">${escapeHtml(p.name)}</div>
              <div class="sub mono">${escapeHtml(p.id)}</div>
            </div>
            ${statusTag(p.status)}
          </div>

          <div class="hr"></div>

          <label>Statut</label>
          <select data-pid="${p.id}">
            <option value="EN_ATTENTE" ${p.status==="EN_ATTENTE"?"selected":""}>EN_ATTENTE</option>
            <option value="QUALIFIE" ${p.status==="QUALIFIE"?"selected":""}>QUALIFIE</option>
            <option value="ELIMINE" ${p.status==="ELIMINE"?"selected":""}>ELIMINE</option>
          </select>

          <div class="row" style="margin-top:12px">
            <button class="btn success" data-save="${p.id}">üíæ Sauvegarder</button>
          </div>
        `;
        playersList.appendChild(el);
      });

      playersList.querySelectorAll("[data-save]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const pid = btn.getAttribute("data-save");
          const sel = playersList.querySelector(`select[data-pid="${pid}"]`);
          const p = (data.players||[]).find(x=>x.id===pid);
          if(!p) return;
          p.status = sel.value;
          data.history.unshift({ts:new Date().toISOString(), type:"PLAYER_UPDATE", actor: adminName.value||"Admin", message:`Statut modifi√©: ${p.name} -> ${p.status}`});
          saveData(data);
          renderAll();
          debug("‚úÖ Joueur mis √† jour.");
        });
      });
    }

    function renderMatches(){
      const rf = roundFilter.value;
      const ms = (data.matches||[]).filter(m=>m.round===rf);
      matchesList.innerHTML = "";
      if(!ms.length){
        matchesList.innerHTML = `<div class="card">Aucun match dans ${escapeHtml(rf)}.</div>`;
        return;
      }

      ms.forEach(m=>{
        const a = getPlayerById(m.aId)?.name || m.aId;
        const b = getPlayerById(m.bId)?.name || m.bId;
        const done = m.status==="TERMINE";
        const score = done ? `${m.scoreA}-${m.scoreB}` : "√Ä jouer";

        const proof = (done && m.proofUrl) ? `
          <div class="imgPrev" style="margin-top:10px">
            <div class="sub">üì∏ Preuve</div>
            <a href="${m.proofUrl}" target="_blank" rel="noopener">
              <img src="${m.proofUrl}" alt="preuve" loading="lazy">
            </a>
          </div>` : "";

        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML = `
          <div class="row">
            <div>
              <div class="kicker">${escapeHtml(m.id)} ¬∑ ${escapeHtml(m.round)}</div>
              <div class="big">${escapeHtml(a)} <span class="mono">vs</span> ${escapeHtml(b)}</div>
              <div class="sub">Statut: <b>${escapeHtml(m.status||"A_JOUER")}</b> ¬∑ Score: <b>${escapeHtml(score)}</b></div>
            </div>
            <span class="pill mono">${escapeHtml(m.aId)} | ${escapeHtml(m.bId)}</span>
          </div>

          <div class="hr"></div>

          <div class="row2">
            <div style="flex:1;min-width:140px">
              <label>Score A</label>
              <input type="number" min="0" step="1" data-mid="${m.id}" data-f="sa" value="${done?m.scoreA:""}" placeholder="5">
            </div>
            <div style="flex:1;min-width:140px">
              <label>Score B</label>
              <input type="number" min="0" step="1" data-mid="${m.id}" data-f="sb" value="${done?m.scoreB:""}" placeholder="2">
            </div>
            <div style="flex:2;min-width:220px">
              <label>Preuve (URL image directe)</label>
              <input data-mid="${m.id}" data-f="pu" value="${m.proofUrl||""}" placeholder="https://i.ibb.co/.../image.webp">
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button class="btn success" data-validate="${m.id}">‚úÖ Valider</button>
          </div>

          ${proof}
        `;
        matchesList.appendChild(el);
      });

      matchesList.querySelectorAll("[data-validate]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          clearDebug();
          const mid = btn.getAttribute("data-validate");
          const sa = matchesList.querySelector(`input[data-mid="${mid}"][data-f="sa"]`).value;
          const sb = matchesList.querySelector(`input[data-mid="${mid}"][data-f="sb"]`).value;
          const pu = matchesList.querySelector(`input[data-mid="${mid}"][data-f="pu"]`).value.trim();

          try{
            const m = (data.matches||[]).find(x=>x.id===mid);
            if(!m) throw new Error("Match introuvable.");
            const A = getPlayerById(m.aId); const B = getPlayerById(m.bId);
            if(!A || !B) throw new Error("Joueur introuvable (aId/bId).");

            const sA = Number(sa), sB = Number(sb);
            if(!Number.isFinite(sA) || !Number.isFinite(sB)) throw new Error("Score invalide.");
            if(sA===sB) throw new Error("√âgalit√© interdite (√©limination directe).");
            if(pu && !/\.(png|jpg|jpeg|webp)(\?.*)?$/i.test(pu)) throw new Error("Preuve doit finir par .png/.jpg/.webp");

            m.scoreA = sA; m.scoreB = sB; m.status = "TERMINE";
            m.proofUrl = pu || m.proofUrl || "";
            m.playedAt = new Date().toISOString();
            m.validatedBy = adminName.value || "Admin";

            const winnerId = sA > sB ? m.aId : m.bId;
            const loserId  = sA > sB ? m.bId : m.aId;
            m.winnerId = winnerId; m.loserId = loserId;

            const W = getPlayerById(winnerId); const L = getPlayerById(loserId);
            if(W) W.status = "QUALIFIE";
            if(L) L.status = "ELIMINE";

            data.history.unshift({ts:new Date().toISOString(), type:"MATCH_VALIDATE", actor: adminName.value||"Admin",
              message:`Match ${m.id} valid√©: ${A.name} ${sA}-${sB} ${B.name}.`
            });

            saveData(data);
            renderAll();
            debug("‚úÖ Match valid√© et statuts mis √† jour.");
          }catch(e){
            debug("‚ùå " + String(e.message || e));
          }
        });
      });
    }

    function renderAll(){
      renderDashboard();
      renderPlayers();
      renderMatches();
    }

    function fillRoundFilter(){
      roundFilter.innerHTML = "";
      rounds().forEach(r=>{
        const opt = document.createElement("option");
        opt.value = r; opt.textContent = r;
        roundFilter.appendChild(opt);
      });
      roundFilter.value = rounds()[0] || "R32";
    }

    function download(filename, text){
      const blob = new Blob([text], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    btnExport.addEventListener("click", ()=>{
      download("efootpro.export.json", JSON.stringify(data, null, 2));
      debug("‚úÖ Export t√©l√©charg√©.");
    });

    btnImport.addEventListener("click", async ()=>{
      clearDebug();
      const f = importFile.files?.[0];
      if(!f){ debug("‚ùå Choisis un fichier JSON."); return; }
      try{
        const txt = await f.text();
        const obj = JSON.parse(txt);
        normalizeData(obj);
        data = obj;
        data.history.unshift({ts:new Date().toISOString(), type:"IMPORT", actor: adminName.value||"Admin", message:"Import JSON effectu√©."});
        saveData(data);
        fillRoundFilter();
        renderAll();
        debug("‚úÖ Import OK.");
      }catch(e){
        debug("‚ùå Import impossible: " + String(e.message||e));
      }
    });

    btnReset.addEventListener("click", async ()=>{
      resetData();
      data = await loadData();
      fillRoundFilter();
      renderAll();
      debug("‚ôªÔ∏è Reset OK (retour au data.json officiel).");
    });

    function generateNextRoundFromCurrent(){
      clearDebug();
      generateStatus.textContent = "Analyse...";
      
      const order = ["R32","R16","QF","SF","F"];
      let currentRound = null;
      let nextRound = null;
      
      // Trouver le round actuel (premier avec des matchs non termin√©s)
      for(let i = 0; i < order.length; i++){
        const round = order[i];
        const matches = (data.matches||[]).filter(m=>m.round===round);
        if(matches.length > 0){
          if(matches.some(m=>m.status!=="TERMINE")){
            currentRound = round;
            nextRound = order[i+1];
            break;
          } else if(i < order.length - 1){
            // Tous les matchs sont termin√©s, on peut g√©n√©rer le suivant
            currentRound = round;
            nextRound = order[i+1];
            break;
          }
        }
      }
      
      if(!currentRound){
        generateStatus.textContent = "‚ùå Aucun round trouv√©";
        return;
      }
      
      if(!nextRound){
        generateStatus.textContent = "‚úÖ Tournoi termin√© !";
        return;
      }
      
      // V√©rifier que tous les matchs du round actuel sont termin√©s
      const currentMatches = (data.matches||[]).filter(m=>m.round===currentRound);
      if(currentMatches.some(m=>m.status!=="TERMINE")){
        generateStatus.textContent = `‚ùå Tous les matchs du ${currentRound} doivent √™tre termin√©s`;
        return;
      }
      
      // V√©rifier que le prochain round n'existe pas d√©j√†
      const existingNext = (data.matches||[]).some(m=>m.round===nextRound);
      if(existingNext){
        generateStatus.textContent = `‚ùå Le round ${nextRound} existe d√©j√†`;
        return;
      }
      
      try{
        // G√©n√©rer les gagnants
        const winners = currentMatches.map(m=>m.winnerId).filter(Boolean);
        if(winners.length % 2 !== 0){
          generateStatus.textContent = `‚ùå Nombre de gagnants impair : ${winners.length}`;
          return;
        }
        
        // Cr√©er les matchs du round suivant
        const created = [];
        let idx = (data.matches||[]).length + 1;
        
        for(let i = 0; i < winners.length; i += 2){
          created.push({
            id: "m" + String(idx++).padStart(2,"0"),
            round: nextRound,
            aId: winners[i],
            bId: winners[i+1],
            status: "A_JOUER"
          });
        }
        
        data.matches.push(...created);
        
        // Historique
        data.history.unshift({
          ts: new Date().toISOString(),
          type: "ROUND_GENERATE",
          actor: adminName.value || "Admin",
          message: `Round ${nextRound} g√©n√©r√© depuis ${currentRound} (${created.length} matchs).`
        });
        
        saveData(data);
        fillRoundFilter();
        renderAll();
        
        generateStatus.textContent = `‚úÖ ${created.length} matchs g√©n√©r√©s pour le round ${nextRound}`;
        debug(`‚úÖ Round ${nextRound} g√©n√©r√© avec succ√®s`);
        
      }catch(e){
        generateStatus.textContent = `‚ùå Erreur: ${e.message}`;
        debug("‚ùå Erreur g√©n√©ration: " + String(e.message||e));
      }
    }

    btnChangePin.addEventListener("click", ()=>{
      clearDebug();
      const p = (newPin.value||"").trim();
      if(!/^\d{4,8}$/.test(p)){ debug("‚ùå PIN invalide. 4 √† 8 chiffres."); return; }
      setPin(p);
      newPin.value = "";
      debug("‚úÖ PIN chang√©.");
    });

    btnGenerateNext.addEventListener("click", generateNextRoundFromCurrent);

    playerSearch.addEventListener("input", renderPlayers);
    roundFilter.addEventListener("change", renderMatches);

    btnLogin.addEventListener("click", async ()=>{
      clearDebug();
      const pin = (pinInput.value||"").trim();
      if(pin !== getPin()){ debug("‚ùå Mauvais PIN."); return; }

      setAuthed(true);
      btnLogout.classList.remove("hide");
      loginCard.classList.add("hide");
      appCard.classList.remove("hide");

      try{
        data = await loadData();
        if(!adminName.value) adminName.value = "SOLITAIRE HACK üá®üáÆ";
        fillRoundFilter();
        renderAll();
        showTab("dash");
        debug("‚úÖ Connect√©. Data charg√©e.");
      }catch(e){
        debug("‚ùå " + String(e.message||e));
      }
    });

    btnLogout.addEventListener("click", ()=>{
      setAuthed(false);
      appCard.classList.add("hide");
      loginCard.classList.remove("hide");
      btnLogout.classList.add("hide");
      pinInput.value = "";
      clearDebug();
    });

    // Auto init
    (async function init(){
      try{
        if(isAuthed()){
          btnLogin.click();
        } else {
          debug("INFO: ouvre /admin.html ‚Äî puis connecte-toi. Si admin ne s‚Äôaffiche pas, alors Vercel ne d√©ploie pas la racine.");
        }
      }catch(e){
        debug("‚ùå " + String(e.message||e));
      }
    })();
  </script>
</body>
</html>