<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin â€” LES Ã‰LITES EFOOTPRO</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="styles.css">
  <style>
    .header{margin-bottom:16px}
    .debug{margin-top:10px}
    .card{margin-top:12px}
    .sub{color:var(--muted);font-size:12px}
    .btn{margin:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <h1>LES Ã‰LITES <span style="color:var(--green)">EFOOTPRO</span></h1>
      <div class="sub">Administration du tournoi</div>
      <nav class="nav">
        <a href="index.html" class="nav-btn">ğŸ  Accueil</a>
        <a href="candidats.html" class="nav-btn">ğŸ‘¥ Candidats</a>
        <a href="matchs.html" class="nav-btn">âš½ Matchs</a>
        <a href="admin.html" class="nav-btn active">âš™ï¸ Admin</a>
      </nav>
    </header>

    <div id="loginCard" class="card">
      <h2>ğŸ” Connexion Admin</h2>
      <div class="sub">PIN : <b>****</b></div>
      <label>PIN</label>
      <input id="pinInput" type="password" placeholder="****" />
      <button id="btnLogin" class="btn">âœ… Se connecter</button>
      <div id="debug" class="debug" style="display:none;"></div>
    </div>

    <div id="appCard" class="card" style="display:none;">
      <h2>ğŸ“Š Tableau de bord</h2>
      <div id="dashboard"></div>
      
      <div class="card" style="margin-top:20px;">
        <h3>ğŸ“¤ Exporter</h3>
        <button id="btnExport" class="btn">ğŸ“¤ TÃ©lÃ©charger JSON</button>
        <button id="btnPdf" class="btn">ğŸ“„ TÃ©lÃ©charger PDF</button>
      </div>
      
      <div class="card" style="margin-top:20px;">
        <h3>ğŸ”„ RÃ©initialiser</h3>
        <button id="btnReset" class="btn danger">â™»ï¸ RÃ©initialiser</button>
      </div>
    </div>

    <footer>SignÃ© SOLITAIRE HACK ğŸ‡¨ğŸ‡®</footer>
  </div>

<script>
const LS_KEY = "tournamentData";
const PIN_KEY = "efootpro_admin_pin";
const AUTH_KEY = "efootpro_admin_auth";

let data = null;

// Fonctions de base
function getPin(){ 
  const stored = localStorage.getItem(PIN_KEY);
  if(stored) return stored;
  // PIN masquÃ© - changez rÃ©guliÃ¨rement
  const chars = [54,54,50,52]; // 6,6,2,4
  return String.fromCharCode(...chars);
}
function setPin(p){ localStorage.setItem(PIN_KEY, p); }
function isAuthed(){ return localStorage.getItem(AUTH_KEY)==="1"; }
function setAuthed(v){ localStorage.setItem(AUTH_KEY, v?"1":"0"); }

function debug(msg){
  const el = document.getElementById("debug");
  el.style.display = "block";
  el.textContent = msg;
}

function clearDebug(){
  document.getElementById("debug").style.display = "none";
}

async function loadData(){
  const local = localStorage.getItem(LS_KEY);
  if(local){
    try{ return JSON.parse(local); }
    catch(e){ localStorage.removeItem(LS_KEY); }
  }
  const res = await fetch("/data.json?ts="+Date.now(), {cache:"no-store"});
  if(!res.ok) throw new Error("data.json introuvable");
  return await res.json();
}

function saveData(d){
  localStorage.setItem(LS_KEY, JSON.stringify(d));
}

function normalizeData(d){
  if(!d.players) d.players = [];
  if(!d.matches) d.matches = [];
  if(!d.history) d.history = [];
}

function countPlayers(){
  const ps = data.players||[];
  return {
    total: ps.length,
    qualified: ps.filter(p=>p.status==="QUALIFIE").length,
    eliminated: ps.filter(p=>p.status==="ELIMINE").length,
    waiting: ps.filter(p=>p.status==="EN_ATTENTE").length
  };
}

function countMatches(){
  const ms = data.matches||[];
  return {
    total: ms.length,
    finished: ms.filter(m=>m.status==="TERMINE").length,
    pending: ms.filter(m=>m.status!=="TERMINE").length
  };
}

function renderDashboard(){
  const pc = countPlayers();
  const mc = countMatches();
  
  document.getElementById("dashboard").innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
      <div class="card">
        <h4>ğŸ‘¥ Joueurs</h4>
        <div>Total: <b>${pc.total}</b></div>
        <div>ğŸŸ¢ QualifiÃ©s: <b>${pc.qualified}</b></div>
        <div>ğŸ”´ Ã‰liminÃ©s: <b>${pc.eliminated}</b></div>
        <div>ğŸŸ  En attente: <b>${pc.waiting}</b></div>
      </div>
      <div class="card">
        <h4>âš½ Matchs</h4>
        <div>Total: <b>${mc.total}</b></div>
        <div>âœ… TerminÃ©s: <b>${mc.finished}</b></div>
        <div>â³ En cours: <b>${mc.pending}</b></div>
      </div>
    </div>
  `;
}

function download(filename, text){
  const blob = new Blob([text], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}

function generatePdf(){
  if(!data) return;
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  doc.setFontSize(20);
  doc.text("LES Ã‰LITES EFOOTPRO", 105, 20, { align: 'center' });
  doc.setFontSize(12);
  doc.text("Rapport du Tournoi", 105, 30, { align: 'center' });
  
  let y = 50;
  doc.setFontSize(10);
  
  const pc = countPlayers();
  const mc = countMatches();
  
  doc.text(`Joueurs: ${pc.total} | QualifiÃ©s: ${pc.qualified} | Ã‰liminÃ©s: ${pc.eliminated}`, 20, y);
  y += 10;
  doc.text(`Matchs: ${mc.total} | TerminÃ©s: ${mc.finished} | En cours: ${mc.pending}`, 20, y);
  
  doc.save(`tournoi-${Date.now()}.pdf`);
}

// Ã‰vÃ©nements
document.getElementById("btnLogin").addEventListener("click", async ()=>{
  const pin = document.getElementById("pinInput").value.trim();
  
  if(pin !== "6624"){
    debug("âŒ PIN incorrect. Le PIN est: 6624");
    return;
  }
  
  setAuthed(true);
  document.getElementById("loginCard").style.display = "none";
  document.getElementById("appCard").style.display = "block";
  
  try{
    data = await loadData();
    normalizeData(data);
    renderDashboard();
    debug("âœ… ConnectÃ© avec succÃ¨s !");
  }catch(e){
    debug("âŒ Erreur: " + e.message);
  }
});

document.getElementById("btnExport").addEventListener("click", ()=>{
  if(!data) return;
  download("tournoi.json", JSON.stringify(data, null, 2));
  debug("âœ… JSON exportÃ©");
});

document.getElementById("btnPdf").addEventListener("click", ()=>{
  generatePdf();
  debug("âœ… PDF gÃ©nÃ©rÃ©");
});

document.getElementById("btnReset").addEventListener("click", ()=>{
  if(confirm("RÃ©initialiser toutes les donnÃ©es ?")){
    localStorage.removeItem(LS_KEY);
    location.reload();
  }
});

// Auto-connexion si dÃ©jÃ  authentifiÃ©
if(isAuthed()){
  document.getElementById("loginCard").style.display = "none";
  document.getElementById("appCard").style.display = "block";
  loadData().then(d=>{
    data = d;
    normalizeData(data);
    renderDashboard();
  });
}
</script>
</body>
</html>
